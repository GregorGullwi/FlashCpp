---
name: CI - MSVC primary

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  windows-debug:
    name: Windows - MSVC - Debug
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild (Visual Studio)
        uses: microsoft/setup-msbuild@v1

      - name: Build solution (Debug)
        shell: powershell
        run: |
          # Build the solution with MSBuild (Debug)
          msbuild FlashCpp.sln /p:Configuration=Debug /m

      - name: Locate and run test executable
        shell: powershell
        run: |
          # Find the first test .exe that looks like the test runner and run it
          $testExe = Get-ChildItem -Path . -Filter "test*.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $testExe) {
            Write-Error "Test executable not found. Search output:"; Get-ChildItem -Path . -Filter "*.exe" -Recurse | Select-Object -First 50; exit 1
          }
          Write-Host "Found test exe: $($testExe.FullName)"
          & $testExe.FullName

  windows-test:
    name: Windows - MSVC - Test
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild (Visual Studio)
        uses: microsoft/setup-msbuild@v1

      - name: Build solution (Test)
        shell: powershell
        run: |
          # Build the solution with MSBuild (Test)
          msbuild FlashCpp.sln /p:Configuration=Test /m

      - name: Locate and run test executable
        shell: powershell
        run: |
          # Find the first test .exe that looks like the test runner and run it
          $testExe = Get-ChildItem -Path . -Filter "test*.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $testExe) {
            Write-Error "Test executable not found. Search output:"; Get-ChildItem -Path . -Filter "*.exe" -Recurse | Select-Object -First 50; exit 1
          }
          Write-Host "Found test exe: $($testExe.FullName)"
          & $testExe.FullName
